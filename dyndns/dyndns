#!/bin/sh
#
# $Id: dyndns,v 1.26 2010/02/09 16:24:36 iku Exp $
#
# Copyright (c) 2008,2009,2010 Antti Harri <iku@openbsd.fi>
#

# Common.
PATH=/bin:/sbin:/usr/bin:/usr/sbin
SYSCONFDIR=/etc
SCRIPTDIR=$(cd -- "$(dirname -- "$0")"; pwd)
# Expire time, can be 'IN' or '30' for example
EXPIRE=30

debuglog()
{
	if [ "$DEBUG" = 1 ]; then
		echo "$1"
	fi
}

if [ -f "${SYSCONFDIR}/dyndns.conf" ]; then
	. "${SYSCONFDIR}/dyndns.conf"
elif [ -f "${SCRIPTDIR}/etc/dyndns.conf" ]; then
	SYSCONFDIR="${SCRIPTDIR}/etc"
	. "${SYSCONFDIR}/dyndns.conf"
else
	echo "Configuration does not exist"
	exit 1
fi

# Tmp
TMP=$(mktemp) || exit 1
trap "rm -f \"$TMP\"" 0 1 2 13 15

# Server mode.
# Init
cd "$HOSTS_DIR" || exit 1

# Cache dir
if [ ! -d "$CACHE" ]; then
	mkdir "$CACHE" || exit 1
fi

while true; do
	# We are in $HOSTS_DIR
	for i in *; do
		DOMAIN=$(printf "%s\n" "$i" | cut -f 2- -d '.')
		HOST=$(printf "%s\n" "$i" | cut -f 1 -d '.')
		ZONEFILE="${ZONEDIR}/$DOMAIN"
		test -e "$ZONEFILE"  || continue
		cp "$ZONEFILE" "$TMP" || exit 1
		cmp -s "$i" "$CACHE/$i"
		if [ "$?" != 0 ]; then
			if [ ! -f "$CACHE/$i" ]; then
				cp "$i" "$CACHE/"
			fi

			IP=$(head -n 1 "$i" | egrep -e '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$')
			if [ -n "$IP" ]; then
				MODIFIED=1
				perl -pi -e "s/^$HOST\s+(IN|\d+)\s+A.*/$HOST\t$EXPIRE\tA\t$IP/" "$TMP"
				cp "$i" "$CACHE/"
			fi
		fi
		if [ "$MODIFIED" = 1 ]; then
			unset MODIFIED
			date=$(date +%s)
			perl -pi -e "s/[[:digit:]]+\s.*serial/$date ; serial/" "$TMP"
			debuglog "Copying to $ZONEFILE"
			cp "$TMP" "$ZONEFILE" || exit 1
			debuglog "Reloading named"
			sudo rndc reload > /dev/null
		fi
	done
	sleep 30
done
