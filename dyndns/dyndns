#!/bin/sh
#
# $Id: dyndns,v 1.16 2008/05/28 04:50:43 iku Exp $
#
# Copyright (c) 2008 Antti Harri <iku@openbsd.fi>
#

# Common.
PATH=/bin:/sbin:/usr/bin:/usr/sbin
SYSCONFDIR=/etc
SCRIPTDIR=$(cd -- "$(dirname -- "$0")"; pwd)

debuglog()
{
	if [ "$DEBUG" = 1 ]; then
		echo "$1"
	fi
}

if [ -f "${SYSCONFDIR}/dyndns.conf" ]; then
	. "${SYSCONFDIR}/dyndns.conf"
elif [ -f "${SCRIPTDIR}/etc/dyndns.conf" ]; then
	SYSCONFDIR="${SCRIPTDIR}/etc"
	. "${SYSCONFDIR}/dyndns.conf"
else
	echo "Configuration does not exist"
	exit 1
fi

# No parameters.
if [ -z "$1" ]; then
	echo "Give interface name as an argument"
	exit 1

# Server mode.
elif [ "$1" = "-s" ]; then
	# Init
	cd "$HOSTS_DIR" || exit 1

	# Tmp
	TMP=$(mktemp) || exit 1
	trap "rm -f \"$TMP\"" EXIT

	# Cache dir
	if [ ! -d "$CACHE" ]; then
		mkdir "$CACHE" || exit 1
	fi

	while true; do
		cp "$ZONE" "$TMP" || exit 1
		for h in *.host; do
			cmp -s "$h" "$CACHE/$h"
			if [ "$?" != 0 ]; then
				if [ ! -f "$CACHE/$h" ]; then
					cp "$h" "$CACHE/"
				fi
				MODIFIED=1

				IP=$(cat "$h")
				h=$(echo "$h" | cut -f 1 -d '.')
				perl -pi -e "s/^$h\s+IN\s+A.*/$h\tIN\tA\t$IP/" "$TMP"
				cp "$h.host" "$CACHE/"
			fi
		done
		if [ "$MODIFIED" = 1 ]; then
			unset MODIFIED
			date=$(date +%s)
			perl -pi -e "s/[[:digit:]]+\s.*serial/$date ; serial/" "$TMP"
			debuglog "Copying to $ZONE"
			cp "$TMP" "$ZONE" || exit 1
			debuglog "Reloading named"
			sudo rndc reload > /dev/null
		fi
		sleep 20
	done

# Client mode.
else
	if [ ! -f "$KEY" ]; then
		echo "You must generate pubkey before using! Just execute ssh-keygen"
		echo "and save it as $KEY"
		exit 1
	fi
	# Get IP from ifconfig
	IP=$(ifconfig "$1" | fgrep 'inet ' | awk '{print $2 }') || exit 1
	# Weed out local IPs
	IP=$(printf '%s\n' "$IP" | egrep -v '^(10\.|172\.|192\.)')

	if [ -z "$IP" ]; then
		debuglog 'Empty IP variable'
		exit 1
	fi
	debuglog "Sending IP=$IP to $DEST"

	MYHOST=$(hostname -s)

	ssh \
		-i "$KEY" \
		-o PasswordAuthentication=no \
		-o BatchMode=yes \
		"${USER}@${DEST}" \
		"echo $IP > ${MYHOST}.host"
fi
